# Reusable CD workflow for Python projects on Render
# Usage:
#   jobs:
#     deploy:
#       uses: diegutierrez/.github/.github/workflows/python-deploy.yml@main
#       with:
#         service-name: "my-service"
#       secrets:
#         RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}

name: Python Deploy

on:
  workflow_call:
    inputs:
      service-name:
        description: "Name of the service being deployed"
        type: string
        required: true
      health-endpoint:
        description: "Health check endpoint path"
        type: string
        default: "/health"
      health-wait-seconds:
        description: "Seconds to wait before health check"
        type: number
        default: 60
      health-retries:
        description: "Number of health check retries"
        type: number
        default: 5
    secrets:
      RENDER_DEPLOY_HOOK_URL:
        description: "Render deploy hook URL"
        required: true
      BOT_HEALTH_URL:
        description: "Base URL for health check"
        required: false
      TELEGRAM_BOT_TOKEN:
        description: "Telegram bot token for notifications"
        required: false
      TELEGRAM_CHAT_ID:
        description: "Telegram chat ID for notifications"
        required: false

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy
        run: |
          echo "Deploying ${{ inputs.service-name }}..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "Deploy triggered successfully"

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ secrets.BOT_HEALTH_URL != '' }}
    steps:
      - name: Wait for deployment
        run: sleep ${{ inputs.health-wait-seconds }}

      - name: Check health endpoint
        run: |
          for i in $(seq 1 ${{ inputs.health-retries }}); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.BOT_HEALTH_URL }}${{ inputs.health-endpoint }}" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i/${{ inputs.health-retries }}: Status $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "Health check failed after ${{ inputs.health-retries }} attempts"
          exit 1

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always() && secrets.TELEGRAM_BOT_TOKEN != ''
    steps:
      - name: Send Telegram notification
        run: |
          if [ "${{ needs.health-check.result }}" = "success" ] || [ "${{ needs.health-check.result }}" = "skipped" ]; then
            MESSAGE="%E2%9C%85 *${{ inputs.service-name }} Deploy Success*%0A%0ACommit: ${{ github.sha }}%0ABranch: ${{ github.ref_name }}"
          else
            MESSAGE="%E2%9D%8C *${{ inputs.service-name }} Deploy Failed*%0A%0ACommit: ${{ github.sha }}%0ABranch: ${{ github.ref_name }}%0A%0ACheck: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" || echo "Telegram notification failed"
        continue-on-error: true
